<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Hardening the USB Armory (part 2) | r1cebank's code &amp; üçó</title><meta name="keywords" content="linux,security,luks,usbarmory"><meta name="author" content="r1cebank,rbnk@elica.io"><meta name="copyright" content="r1cebank"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Earlier we talked about trying to hardening the USB Armory, but given all the information I have found online, I need to figure out some custom way of generating the image so the secure environment ca">
<meta property="og:type" content="article">
<meta property="og:title" content="Hardening the USB Armory (part 2)">
<meta property="og:url" content="https://r1ce.net/2021/03/17/hardening-usb-armory-2/index.html">
<meta property="og:site_name" content="r1cebank&#39;s code &amp; üçó">
<meta property="og:description" content="Earlier we talked about trying to hardening the USB Armory, but given all the information I have found online, I need to figure out some custom way of generating the image so the secure environment ca">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://r1ce.net/covers/usbarmorymkiilayout.webp">
<meta property="article:published_time" content="2021-03-17T05:26:15.000Z">
<meta property="article:modified_time" content="2021-12-03T05:12:38.302Z">
<meta property="article:author" content="r1cebank">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="security">
<meta property="article:tag" content="luks">
<meta property="article:tag" content="usbarmory">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://r1ce.net/covers/usbarmorymkiilayout.webp"><link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/261671"><link rel="canonical" href="https://r1ce.net/2021/03/17/hardening-usb-armory-2/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.clarity.ms"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "9k4dnvks84");</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Hardening the USB Armory (part 2)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-12-02 21:12:38'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://avatars.githubusercontent.com/u/261671" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">18</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">20</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">21</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/Food"><i class="fa-fw fas fa-drumstick-bite"></i><span> Food</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/covers/usbarmorymkiilayout.webp')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">r1cebank's code &amp; üçó</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/Food"><i class="fa-fw fas fa-drumstick-bite"></i><span> Food</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Hardening the USB Armory (part 2)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-03-17T05:26:15.000Z" title="Created 2021-03-16 22:26:15">2021-03-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-12-03T05:12:38.302Z" title="Updated 2021-12-02 21:12:38">2021-12-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Tutorial/">Tutorial</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Tutorial/Hardware/">Hardware</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Hardening the USB Armory (part 2)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>Earlier we talked about trying to hardening the USB Armory, but given all the information I have found online, I need to figure out some custom way of generating the image so the secure environment can be easily reproduced.</p>
<ul>
<li>Custom Kernel + initramfs (for pre-boot LUKS unlock)</li>
<li>Seperate /boot partition (unencrypted but signed to unlock the rootfs)</li>
<li>Makefile to create multi-partition images</li>
<li>Makefile to create LUKS images</li>
<li>Signed bootloader with the image</li>
</ul>
<h2 id="Step-1-Initramfs"><a href="#Step-1-Initramfs" class="headerlink" title="Step 1. Initramfs"></a>Step 1. Initramfs</h2><p>This is the hardest part and took me a couple days to figure out, mainly due to I had zero experience with Linux Kernel and I had to read a lot of documentation and outdated documentation to figure out what to do. To learn more about initramfs, here is a super dated documentation from kernel.org, but it should explain everything you needed to know.</p>
<p><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/filesystems/ramfs-rootfs-initramfs.html">Ramfs, rootfs and initramfs ‚Äî The Linux Kernel documentation</a></p>
<p><a target="_blank" rel="noopener" href="https://wiki.gentoo.org/wiki/Initramfs/Guide">Initramfs/Guide - Gentoo Wiki</a></p>
<p>After many trial and errors, I figured out an way to embed the initramfs in the kernel zImage and have it run a prompt during boot.</p>
<ul>
<li>Build busybox</li>
<li>Create the filesystem structure</li>
<li>Mount devtmpfs and tmpfs</li>
<li>Make sure /dev/console exist with mknod</li>
</ul>
<p>At the end, the make target will look like this:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">initramfs: busybox-bin-$&#123;BUSYBOX_VER&#125; init</span></span><br><span class="line">    mkdir -pv initramfs/&#123;bin,dev,sbin,etc,run,boot,proc,sys/kernel/debug,usr/&#123;bin,sbin&#125;,lib/modules,mnt/root,root&#125;</span><br><span class="line">    cp -av busybox-$&#123;BUSYBOX_VER&#125;/_install/* initramfs</span><br><span class="line">    cp init initramfs</span><br><span class="line">    chmod +x initramfs/init</span><br><span class="line">    mkdir -p initramfs/dev</span><br><span class="line">    cp prebuilt/$&#123;LINUX_VER&#125;/dcp_derive initramfs/usr/sbin</span><br><span class="line">    cp prebuilt/$&#123;LINUX_VER&#125;/armoryctl initramfs/usr/sbin</span><br><span class="line">    chmod +x initramfs/usr/sbin/dcp_derive</span><br><span class="line">    chmod +x initramfs/usr/sbin/armoryctl</span><br><span class="line">    cp -av prebuilt/$&#123;LINUX_VER&#125;/modules initramfs/lib</span><br><span class="line">    mkdir -p initramfs/lib/modules/$&#123;LINUX_VER&#125;-0</span><br><span class="line">    @if test <span class="string">&quot;$&#123;IMX&#125;&quot;</span> = <span class="string">&quot;imx6ulz&quot;</span>; then \</span><br><span class="line">        cp prebuilt/$&#123;LINUX_VER&#125;/mxs-dcp.ko initramfs/lib/modules/$&#123;LINUX_VER&#125;-0/extra; \</span><br><span class="line">    fi</span><br><span class="line">    @if test <span class="string">&quot;$&#123;IMX&#125;&quot;</span> = <span class="string">&quot;imx6ul&quot;</span>; then \</span><br><span class="line">        cp prebuilt/$&#123;LINUX_VER&#125;/caam_keyblob.ko initramfs/lib/modules/$&#123;LINUX_VER&#125;-0/extra; \</span><br><span class="line">    fi</span><br><span class="line">    cd initramfs/dev &amp;&amp; \</span><br><span class="line">        mknod -m 622 console c 5 1 &amp;&amp; \</span><br><span class="line">        mknod -m 622 tty0 c 4 0</span><br><span class="line">    cp -av prebuilt/$&#123;LINUX_VER&#125;/cryptsetup/* initramfs</span><br><span class="line">    echo <span class="string">&quot;leds_gpio&quot;</span> | sudo tee -a initramfs/etc/modules</span><br><span class="line">    echo <span class="string">&quot;led_class&quot;</span> | sudo tee -a initramfs/etc/modules</span><br><span class="line">    echo <span class="string">&quot;mxs_dcp&quot;</span> | sudo tee -a initramfs/etc/modules</span><br><span class="line">    echo <span class="string">&quot;algif_rng&quot;</span> | sudo tee -a initramfs/etc/modules</span><br><span class="line">    echo <span class="string">&quot;algif_skcipher&quot;</span> | sudo tee -a initramfs/etc/modules</span><br><span class="line">    echo <span class="string">&quot;algif_hash&quot;</span> | sudo tee -a initramfs/etc/modules</span><br><span class="line">    echo <span class="string">&quot;af_alg&quot;</span> | sudo tee -a initramfs/etc/modules</span><br><span class="line">    echo <span class="string">&quot;dm_crypt&quot;</span> | sudo tee -a initramfs/etc/modules</span><br></pre></td></tr></table></figure>

<h2 id="Step-2-Init-script"><a href="#Step-2-Init-script" class="headerlink" title="Step 2. Init script"></a>Step 2. Init script</h2><p>After the initramfs is loaded to ram and mapped to root, the kernel will run the init script in the root directory. The init script is responsible for loading modules, running pre-boot actions and at the end <code>switch_root</code> to switch out the current root with the / on the file system. Here is am example of the init scipt with LUKS unlocking:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/busybox /bin/sh</span></span><br><span class="line"><span class="built_in">export</span> PATH=/usr/bin:/usr/sbin:/bin:/sbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># Mount the dev directory</span></span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># Mount the rest of the directory</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -n -t tmpfs    tmpfs    /run</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\nBoot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;********** Starting custom unlock script **********\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;**********    Loading kernel modules     **********\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Loading: dm-crypt\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">modprobe -q dm-crypt</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Loading: af_alg\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">modprobe -q af_alg</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Loading: algif_hash\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">modprobe -q algif_hash</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Loading: algif_skcipher\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">modprobe -q algif_skcipher</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Loading: algif_rng\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">modprobe -q algif_rng</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Loading: mxs_dcp\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">modprobe -q mxs_dcp</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Loading: leds_gpio\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">modprobe -q leds_gpio</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Loading: led_class\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">modprobe -q led_class</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;**********   Kernel modules loaded       **********\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">armoryctl led white on</span><br><span class="line">sleep 2</span><br><span class="line"></span><br><span class="line">armoryctl led blue on</span><br><span class="line"><span class="built_in">printf</span> &#123;LUKS_PASSWORD&#125; | cryptsetup luksOpen /dev/&#123;ROOTFS_DEV&#125;p2 rootfs -d -</span><br><span class="line">armoryctl led blue off</span><br><span class="line">mount /dev/mapper/rootfs /root</span><br><span class="line"></span><br><span class="line">armoryctl led white off</span><br><span class="line"><span class="comment"># Switch root</span></span><br><span class="line"><span class="built_in">exec</span> switch_root -c /dev/console /root /sbin/init</span><br></pre></td></tr></table></figure>

<p>You see we are loading modules and turning on LED, then run cryptsetup to open the partition and later mount it, at the end we call <code>switch_root</code> to start the actual init process</p>
<h2 id="Step-3-Cryptsetup"><a href="#Step-3-Cryptsetup" class="headerlink" title="Step 3. Cryptsetup"></a>Step 3. Cryptsetup</h2><p>This one is a hard one, there are some guides online to build this into a static executable, meaning it can be copied and put on the initramfs without the need to copy all the dynamic modules. I had zero success in that ¬†and decided to make the dynamic executable work.</p>
<p>So I figured, what if I just copy all the shared modules over and maybe it works? So that‚Äôs exactly what I did. I used a tool called ldd</p>
<img src="/2021/03/17/hardening-usb-armory-2/image-1.png" class="" title="cryptsetup required libraries">
<p>So this tool helped me to identify all the dynamic libraries it needs to use, so I copied them over to the initramfs and it works right?</p>
<p>No</p>
<p>During testing I realized the cryptsetup will allow me to unlock the drive, it just quietly quits. After checking verbose outputs and googling, I realized I need to load all the kernel modules that is required by cryptsetup, one of them is essential: dm-crypt.</p>
<p>So I copied it over and it worked!</p>
<p>So up till this point, we built an initramfs with all the kernel modules we need and is able to unlock the LUKS drive and boot from it. But USB armory is a usb device, there is not way we want the users to connect the debug tool and unlock it manually everytime. (some might think this is an added security feature, but I assure you user input during secure boot process is always never good idea.</p>
<p>We could however spin up a SSH server like dropbear and unlock the drive like that, but I want to leverage the DCP processor and secure processors on the device. </p>
<h2 id="Step-4-DCP"><a href="#Step-4-DCP" class="headerlink" title="Step 4. DCP"></a>Step 4. DCP</h2><p>The imx6ullz SoC on the USB Armory has an data co-processor, and it can handle various cryptographic functions. What makes me interested is one of the feature inside the DCP that can be useful to help us create unattended luks unlock.</p>
<p>During manufacturing an key is fused inside this dcp called OTPMK, this key is inaccessable by anyone and the DCP is able to use it to encrypt data. During a secure boot setup, the OTPMK is used, if DCP detects its not in a secure booted enironment, the Non-Volatile key is used.</p>
<p>Here is what I have planned, since we all need to boot with secure boot enabled, how about we embed the DCP encrypted keys in initramfs and let the DCP decrypt it during boot and that result will be out LUKS key.</p>
<p>But the key is exposed and can be read my anyone!</p>
<p>Well, yeah, but its not like they can use it for anything, without DCP to decrypt the key, there is no way to use it to decrypt the LUKS partition. We can also forget attacker injecting some script to dump the DCP decrypted key since once they modify the bootloader, zImage, the secure boot check will fail and the SoC will refuse to run.</p>
<p>There is a case where the attacker can obtain the device and boot it, then it bruteforce the SSH key on the device. Well, if they can get in that way, I guess you probably don‚Äôt have a habit of using strong secure passwords and I think your pre-boot LUKS password will be weak as well.</p>
<p>This concluded my journey to hardening my USB Armory Mk.II, its really an awesome device and I had a lot of fun tinkering with it. If you are interested you can find everything in the GitHub repo below.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/r1cebank/usbarmory-debian-base_image">r1cebank/usbarmory-debian-base_image</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/r1cebank">r1cebank</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://r1ce.net/2021/03/17/hardening-usb-armory-2/">https://r1ce.net/2021/03/17/hardening-usb-armory-2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/linux/">linux</a><a class="post-meta__tags" href="/tags/security/">security</a><a class="post-meta__tags" href="/tags/luks/">luks</a><a class="post-meta__tags" href="/tags/usbarmory/">usbarmory</a></div><div class="post_share"><div class="social-share" data-image="/covers/usbarmorymkiilayout.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2021/03/03/using-bitwarden/"><img class="next-cover" src="/covers/bitwarden.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Using Bitwarden as password manager</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2021/02/27/hardening-usb-armory-1/" title="Hardening the USB Armory (part 1)"><img class="cover" src="/covers/usbarmorymkii.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-26</div><div class="title">Hardening the USB Armory (part 1)</div></div></a></div><div><a href="/2021/02/01/creating-luks-from-existing/" title="Creating luks partition from existing partition"><img class="cover" src="/covers/luks.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-01</div><div class="title">Creating luks partition from existing partition</div></div></a></div><div><a href="/2021/02/22/usbarmory-ii/" title="USB Armory II"><img class="cover" src="/covers/usbarmorymkii.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-22</div><div class="title">USB Armory II</div></div></a></div><div><a href="/2018/04/24/adapta-theme/" title="Adapta Theme Review"><img class="cover" src="/covers/adapta-theme.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-04-24</div><div class="title">Adapta Theme Review</div></div></a></div><div><a href="/2020/07/07/arch-installer-alis/" title="Arch installer - alis"><img class="cover" src="/covers/archlinux.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-06</div><div class="title">Arch installer - alis</div></div></a></div><div><a href="/2021/01/11/docker-ufw/" title="Using docker with ufw"><img class="cover" src="/covers/docker-ufw.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-11</div><div class="title">Using docker with ufw</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/261671" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">r1cebank</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">18</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">20</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">21</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/r1cebank"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/r1cebank" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:rbnk@elica.io" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">Welcome to my blog, this is where I record learnings and write about random stuff. Enjoy ‚ù§Ô∏è</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-1-Initramfs"><span class="toc-number">1.</span> <span class="toc-text">Step 1. Initramfs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-2-Init-script"><span class="toc-number">2.</span> <span class="toc-text">Step 2. Init script</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-3-Cryptsetup"><span class="toc-number">3.</span> <span class="toc-text">Step 3. Cryptsetup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-4-DCP"><span class="toc-number">4.</span> <span class="toc-text">Step 4. DCP</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/03/17/hardening-usb-armory-2/" title="Hardening the USB Armory (part 2)"><img src="/covers/usbarmorymkiilayout.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hardening the USB Armory (part 2)"/></a><div class="content"><a class="title" href="/2021/03/17/hardening-usb-armory-2/" title="Hardening the USB Armory (part 2)">Hardening the USB Armory (part 2)</a><time datetime="2021-03-17T05:26:15.000Z" title="Created 2021-03-16 22:26:15">2021-03-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/03/03/using-bitwarden/" title="Using Bitwarden as password manager"><img src="/covers/bitwarden.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Using Bitwarden as password manager"/></a><div class="content"><a class="title" href="/2021/03/03/using-bitwarden/" title="Using Bitwarden as password manager">Using Bitwarden as password manager</a><time datetime="2021-03-03T09:12:59.000Z" title="Created 2021-03-03 01:12:59">2021-03-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/02/27/hardening-usb-armory-1/" title="Hardening the USB Armory (part 1)"><img src="/covers/usbarmorymkii.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hardening the USB Armory (part 1)"/></a><div class="content"><a class="title" href="/2021/02/27/hardening-usb-armory-1/" title="Hardening the USB Armory (part 1)">Hardening the USB Armory (part 1)</a><time datetime="2021-02-27T07:00:32.000Z" title="Created 2021-02-26 23:00:32">2021-02-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/02/22/usbarmory-ii/" title="USB Armory II"><img src="/covers/usbarmorymkii.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="USB Armory II"/></a><div class="content"><a class="title" href="/2021/02/22/usbarmory-ii/" title="USB Armory II">USB Armory II</a><time datetime="2021-02-22T15:54:42.000Z" title="Created 2021-02-22 07:54:42">2021-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/02/10/how-sega-nu-works-2/" title="How Sega Nu works (part 2)"><img src="/covers/nuarcade.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="How Sega Nu works (part 2)"/></a><div class="content"><a class="title" href="/2021/02/10/how-sega-nu-works-2/" title="How Sega Nu works (part 2)">How Sega Nu works (part 2)</a><time datetime="2021-02-10T06:00:28.000Z" title="Created 2021-02-09 22:00:28">2021-02-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 By r1cebank</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Made with ‚ù§Ô∏è in Vancouver</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      false && mermaid.init()
    })
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>