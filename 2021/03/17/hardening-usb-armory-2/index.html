<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Hardening the USB Armory (part 2) | r1cebank's code &amp; ğŸ— &amp; âœˆï¸</title><meta name="author" content="r1cebank,me@r1ce.net"><meta name="copyright" content="r1cebank"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Earlier we talked about trying to hardening the USB Armory, but given all the information I have found online, I need to figure out some custom way..."><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Hardening the USB Armory (part 2)",
  "url": "https://r1ce.net/2021/03/17/hardening-usb-armory-2/",
  "image": "https://r1ce.net/covers/usbarmorymkiilayout.webp",
  "datePublished": "2021-03-17T05:26:15.000Z",
  "dateModified": "2026-01-08T09:40:51.336Z",
  "author": [
    {
      "@type": "Person",
      "name": "r1cebank",
      "url": "https://github.com/r1cebank"
    }
  ]
}</script><link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/261671"><link rel="canonical" href="https://r1ce.net/2021/03/17/hardening-usb-armory-2/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.clarity.ms"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.3"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "9k4dnvks84");
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Hardening the USB Armory (part 2)',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://avatars.githubusercontent.com/u/261671" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">33</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">19</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/Food"><i class="fa-fw fas fa-drumstick-bite"></i><span> Food</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/covers/usbarmorymkiilayout.webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">r1cebank's code &amp; ğŸ— &amp; âœˆï¸</span></a><a class="nav-page-title" href="/"><span class="site-name">Hardening the USB Armory (part 2)</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/Food"><i class="fa-fw fas fa-drumstick-bite"></i><span> Food</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Hardening the USB Armory (part 2)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-03-17T05:26:15.000Z" title="Created 2021-03-16 22:26:15">2021-03-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2026-01-08T09:40:51.336Z" title="Updated 2026-01-08 01:40:51">2026-01-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Technology/">Technology</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Technology/Tutorials/">Tutorials</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>Earlier we talked about trying to hardening the USB Armory, but given all the information I have found online, I need to figure out some custom way of generating the image so the secure environment can be easily reproduced.</p>
<ul>
<li>Custom Kernel + initramfs (for pre-boot LUKS unlock)</li>
<li>Seperate &#x2F;boot partition (unencrypted but signed to unlock the rootfs)</li>
<li>Makefile to create multi-partition images</li>
<li>Makefile to create LUKS images</li>
<li>Signed bootloader with the image</li>
</ul>
<h2 id="Step-1-Initramfs"><a href="#Step-1-Initramfs" class="headerlink" title="Step 1. Initramfs"></a>Step 1. Initramfs</h2><p>This is the hardest part and took me a couple days to figure out, mainly due to I had zero experience with Linux Kernel and I had to read a lot of documentation and outdated documentation to figure out what to do. To learn more about initramfs, here is a super dated documentation from kernel.org, but it should explain everything you needed to know.</p>
<p><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/filesystems/ramfs-rootfs-initramfs.html">Ramfs, rootfs and initramfs â€” The Linux Kernel documentation</a></p>
<p><a target="_blank" rel="noopener" href="https://wiki.gentoo.org/wiki/Initramfs/Guide">Initramfs&#x2F;Guide - Gentoo Wiki</a></p>
<p>After many trial and errors, I figured out an way to embed the initramfs in the kernel zImage and have it run a prompt during boot.</p>
<ul>
<li>Build busybox</li>
<li>Create the filesystem structure</li>
<li>Mount devtmpfs and tmpfs</li>
<li>Make sure &#x2F;dev&#x2F;console exist with mknod</li>
</ul>
<p>At the end, the make target will look like this:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">initramfs: busybox-bin-$&#123;BUSYBOX_VER&#125; init</span></span><br><span class="line">    mkdir -pv initramfs/&#123;bin,dev,sbin,etc,run,boot,proc,sys/kernel/debug,usr/&#123;bin,sbin&#125;,lib/modules,mnt/root,root&#125;</span><br><span class="line">    cp -av busybox-$&#123;BUSYBOX_VER&#125;/_install/* initramfs</span><br><span class="line">    cp init initramfs</span><br><span class="line">    chmod +x initramfs/init</span><br><span class="line">    mkdir -p initramfs/dev</span><br><span class="line">    cp prebuilt/$&#123;LINUX_VER&#125;/dcp_derive initramfs/usr/sbin</span><br><span class="line">    cp prebuilt/$&#123;LINUX_VER&#125;/armoryctl initramfs/usr/sbin</span><br><span class="line">    chmod +x initramfs/usr/sbin/dcp_derive</span><br><span class="line">    chmod +x initramfs/usr/sbin/armoryctl</span><br><span class="line">    cp -av prebuilt/$&#123;LINUX_VER&#125;/modules initramfs/lib</span><br><span class="line">    mkdir -p initramfs/lib/modules/$&#123;LINUX_VER&#125;-0</span><br><span class="line">    @if test <span class="string">&quot;$&#123;IMX&#125;&quot;</span> = <span class="string">&quot;imx6ulz&quot;</span>; then \</span><br><span class="line">        cp prebuilt/$&#123;LINUX_VER&#125;/mxs-dcp.ko initramfs/lib/modules/$&#123;LINUX_VER&#125;-0/extra; \</span><br><span class="line">    fi</span><br><span class="line">    @if test <span class="string">&quot;$&#123;IMX&#125;&quot;</span> = <span class="string">&quot;imx6ul&quot;</span>; then \</span><br><span class="line">        cp prebuilt/$&#123;LINUX_VER&#125;/caam_keyblob.ko initramfs/lib/modules/$&#123;LINUX_VER&#125;-0/extra; \</span><br><span class="line">    fi</span><br><span class="line">    cd initramfs/dev &amp;&amp; \</span><br><span class="line">        mknod -m 622 console c 5 1 &amp;&amp; \</span><br><span class="line">        mknod -m 622 tty0 c 4 0</span><br><span class="line">    cp -av prebuilt/$&#123;LINUX_VER&#125;/cryptsetup/* initramfs</span><br><span class="line">    echo <span class="string">&quot;leds_gpio&quot;</span> | sudo tee -a initramfs/etc/modules</span><br><span class="line">    echo <span class="string">&quot;led_class&quot;</span> | sudo tee -a initramfs/etc/modules</span><br><span class="line">    echo <span class="string">&quot;mxs_dcp&quot;</span> | sudo tee -a initramfs/etc/modules</span><br><span class="line">    echo <span class="string">&quot;algif_rng&quot;</span> | sudo tee -a initramfs/etc/modules</span><br><span class="line">    echo <span class="string">&quot;algif_skcipher&quot;</span> | sudo tee -a initramfs/etc/modules</span><br><span class="line">    echo <span class="string">&quot;algif_hash&quot;</span> | sudo tee -a initramfs/etc/modules</span><br><span class="line">    echo <span class="string">&quot;af_alg&quot;</span> | sudo tee -a initramfs/etc/modules</span><br><span class="line">    echo <span class="string">&quot;dm_crypt&quot;</span> | sudo tee -a initramfs/etc/modules</span><br></pre></td></tr></table></figure>

<h2 id="Step-2-Init-script"><a href="#Step-2-Init-script" class="headerlink" title="Step 2. Init script"></a>Step 2. Init script</h2><p>After the initramfs is loaded to ram and mapped to root, the kernel will run the init script in the root directory. The init script is responsible for loading modules, running pre-boot actions and at the end <code>switch_root</code> to switch out the current root with the &#x2F; on the file system. Here is am example of the init scipt with LUKS unlocking:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/busybox /bin/sh</span></span><br><span class="line"><span class="built_in">export</span> PATH=/usr/bin:/usr/sbin:/bin:/sbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># Mount the dev directory</span></span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># Mount the rest of the directory</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -n -t tmpfs    tmpfs    /run</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\nBoot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;********** Starting custom unlock script **********\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;**********    Loading kernel modules     **********\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Loading: dm-crypt\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">modprobe -q dm-crypt</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Loading: af_alg\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">modprobe -q af_alg</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Loading: algif_hash\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">modprobe -q algif_hash</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Loading: algif_skcipher\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">modprobe -q algif_skcipher</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Loading: algif_rng\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">modprobe -q algif_rng</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Loading: mxs_dcp\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">modprobe -q mxs_dcp</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Loading: leds_gpio\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">modprobe -q leds_gpio</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Loading: led_class\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">modprobe -q led_class</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;**********   Kernel modules loaded       **********\n&quot;</span> &gt; /dev/kmsg</span><br><span class="line">armoryctl led white on</span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"></span><br><span class="line">armoryctl led blue on</span><br><span class="line"><span class="built_in">printf</span> &#123;LUKS_PASSWORD&#125; | cryptsetup luksOpen /dev/&#123;ROOTFS_DEV&#125;p2 rootfs -d -</span><br><span class="line">armoryctl led blue off</span><br><span class="line">mount /dev/mapper/rootfs /root</span><br><span class="line"></span><br><span class="line">armoryctl led white off</span><br><span class="line"><span class="comment"># Switch root</span></span><br><span class="line"><span class="built_in">exec</span> switch_root -c /dev/console /root /sbin/init</span><br></pre></td></tr></table></figure>

<p>You see we are loading modules and turning on LED, then run cryptsetup to open the partition and later mount it, at the end we call <code>switch_root</code> to start the actual init process</p>
<h2 id="Step-3-Cryptsetup"><a href="#Step-3-Cryptsetup" class="headerlink" title="Step 3. Cryptsetup"></a>Step 3. Cryptsetup</h2><p>This one is a hard one, there are some guides online to build this into a static executable, meaning it can be copied and put on the initramfs without the need to copy all the dynamic modules. I had zero success in that Â and decided to make the dynamic executable work.</p>
<p>So I figured, what if I just copy all the shared modules over and maybe it works? So thatâ€™s exactly what I did. I used a tool called ldd</p>
<img src="/2021/03/17/hardening-usb-armory-2/image-1.png" class="" title="cryptsetup required libraries">
<p>So this tool helped me to identify all the dynamic libraries it needs to use, so I copied them over to the initramfs and it works right?</p>
<p>No</p>
<p>During testing I realized the cryptsetup will allow me to unlock the drive, it just quietly quits. After checking verbose outputs and googling, I realized I need to load all the kernel modules that is required by cryptsetup, one of them is essential: dm-crypt.</p>
<p>So I copied it over and it worked!</p>
<p>So up till this point, we built an initramfs with all the kernel modules we need and is able to unlock the LUKS drive and boot from it. But USB armory is a usb device, there is not way we want the users to connect the debug tool and unlock it manually everytime. (some might think this is an added security feature, but I assure you user input during secure boot process is always never good idea.</p>
<p>We could however spin up a SSH server like dropbear and unlock the drive like that, but I want to leverage the DCP processor and secure processors on the device. </p>
<h2 id="Step-4-DCP"><a href="#Step-4-DCP" class="headerlink" title="Step 4. DCP"></a>Step 4. DCP</h2><p>The imx6ullz SoC on the USB Armory has an data co-processor, and it can handle various cryptographic functions. What makes me interested is one of the feature inside the DCP that can be useful to help us create unattended luks unlock.</p>
<p>During manufacturing an key is fused inside this dcp called OTPMK, this key is inaccessable by anyone and the DCP is able to use it to encrypt data. During a secure boot setup, the OTPMK is used, if DCP detects its not in a secure booted enironment, the Non-Volatile key is used.</p>
<p>Here is what I have planned, since we all need to boot with secure boot enabled, how about we embed the DCP encrypted keys in initramfs and let the DCP decrypt it during boot and that result will be out LUKS key.</p>
<p>But the key is exposed and can be read my anyone!</p>
<p>Well, yeah, but its not like they can use it for anything, without DCP to decrypt the key, there is no way to use it to decrypt the LUKS partition. We can also forget attacker injecting some script to dump the DCP decrypted key since once they modify the bootloader, zImage, the secure boot check will fail and the SoC will refuse to run.</p>
<p>There is a case where the attacker can obtain the device and boot it, then it bruteforce the SSH key on the device. Well, if they can get in that way, I guess you probably donâ€™t have a habit of using strong secure passwords and I think your pre-boot LUKS password will be weak as well.</p>
<p>This concluded my journey to hardening my USB Armory Mk.II, its really an awesome device and I had a lot of fun tinkering with it. If you are interested you can find everything in the GitHub repo below.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/r1cebank/usbarmory-debian-base_image">r1cebank&#x2F;usbarmory-debian-base_image</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/r1cebank">r1cebank</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://r1ce.net/2021/03/17/hardening-usb-armory-2/">https://r1ce.net/2021/03/17/hardening-usb-armory-2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/linux/">linux</a><a class="post-meta__tags" href="/tags/security/">security</a><a class="post-meta__tags" href="/tags/luks/">luks</a><a class="post-meta__tags" href="/tags/usbarmory/">usbarmory</a></div><div class="post-share"><div class="social-share" data-image="/covers/usbarmorymkiilayout.webp" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2021/12/19/beef-stock-1/" title="Beef stock recipe"><img class="cover" src="/covers/food-recipe-3.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Beef stock recipe</div></div><div class="info-2"><div class="info-item-1">Its Christmas time again in the year, a lot people are preparing Christmas roast or some wonderful dinner with their families. I now have a wonderful beef stock recipe that should be perfect for anyone want to use as a base for a wonderfule Au jus or a soup. ç‰›è‚‰é«˜æ±¤åœ¨å¾ˆå¤šåœ£è¯èŠ‚æ—¶æœŸåƒçš„èœéƒ½ä¼šç”¨åˆ°ï¼Œå¹³æ—¶æˆ‘ä¼šå»è¶…å¸‚ç›´æ¥ä¹°åŒ…è£…å¥½çš„ç‰›è‚‰é«˜æ±¤ï¼Œä½†æ˜¯ä¸€ç›´éƒ½è§‰å¾—å‘³é“ä¸å¥½ï¼Œæœ‰çš„æ¯”è¾ƒå’¸ï¼Œæœ‰çš„æœ‰ä¸€äº›æ€ªå‘³ã€‚ä»Šå¤©æˆ‘åˆ†äº«ä¸€ä¸ªæˆ‘å‘ç°çš„ä¸é”™çš„ç‰›è‚‰é«˜æ±¤çš„åšæ³•ï¼Œåšå®Œçš„é«˜æ±¤å¯ä»¥åšæˆé…±æ–™æˆ–è€…æ˜¯æ±¤ï¼Œç”¨å¤„è¿˜æ˜¯è›®å¤šçš„ã€‚ Ingredients åŸæ–™ Beef bone (neck, leg) ç‰›éª¨ Beef scraps or trimmings (preferred with fat) ç‰›è‚‰è¾¹è§’æ–™ï¼Œå¦‚æœæœ‰è‚¥è‚‰æœ€å¥½ Tomato paste ç•ªèŒ„é…±ï¼ˆä¸æ˜¯ç•ªèŒ„æ²™å¸ï¼‰ C...</div></div></div></a><a class="pagination-related" href="/2021/03/03/using-bitwarden/" title="Using Bitwarden as password manager"><img class="cover" src="/covers/bitwarden.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Using Bitwarden as password manager</div></div><div class="info-2"><div class="info-item-1">When I was in high school and starting to know about the danger of password being stolen, I started to change my password every 6 month. It got really crazy as I started to get more and more online accounts. During that time I have no list of all the online accounts and I often forget one of the account and I ended up forgot which pass password that account is using. The I realized using the same password for everything is not a good idea, also there are asshole websites that only allow you t...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2021/02/27/hardening-usb-armory-1/" title="Hardening the USB Armory (part 1)"><img class="cover" src="/covers/usbarmorymkii.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-26</div><div class="info-item-2">Hardening the USB Armory (part 1)</div></div><div class="info-2"><div class="info-item-1">Since last time I wrote about the USB Armory II, I have spent a considerable amount of time working on the device. I have to say it is a very capable device, able to support many tools that I want to run on it. But working with USB Armory with Secure Boot turned on, I have found some issues that is not documented in the wiki. ProblemThe secure boot process will only protect the initial boot process, validating the kernel, but its still easy to modify the filesystem and inject files in to the ...</div></div></div></a><a class="pagination-related" href="/2021/02/22/usbarmory-ii/" title="USB Armory II"><img class="cover" src="/covers/usbarmorymkii.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-22</div><div class="info-item-2">USB Armory II</div></div><div class="info-2"><div class="info-item-1">While browsing Crowd Supply I found a very interesting device called USB Armory. Its a tiny security minded computer in the form factor of a tiny USB stick. The hardware specs is not very amazing but compared with similar device like Raspberry Pi Zero, its not that bad. Hardware SoC: NXP i.MX6ULZ ARMÂ® Cortexâ„¢-A7 900 MHz RAM: 512 MB DDR3 Storage: internal 16 GB eMMC + external microSD Bluetooth module: u-blox ANNA-B112 BLE USB-C ports: DRP (Dual Role Power) receptacle + UFP (Upstream Facing Po...</div></div></div></a><a class="pagination-related" href="/2021/02/01/creating-luks-from-existing/" title="Creating luks partition from existing partition"><img class="cover" src="/covers/luks.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-01</div><div class="info-item-2">Creating luks partition from existing partition</div></div><div class="info-2"><div class="info-item-1">Iâ€™ve been building a self-contained server from an Intel Nuc, recently I decided to move my dropbox to self-hosted Seafile solution. One of the problem is, I did not encrypt the external storage when I did the system setup. When googled about encrypting existing partitions, I came up with a solution. Make sure you back up all of your data  Shrink the partition using resize2fs (make sure calculate the new block size and leave around 32M) Run cryptsetup reencrypt --encrypt /dev/sdXY --reduce-de...</div></div></div></a><a class="pagination-related" href="/2018/04/24/adapta-theme/" title="Adapta Theme Review"><img class="cover" src="/covers/adapta-theme.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-04-24</div><div class="info-item-2">Adapta Theme Review</div></div><div class="info-2"><div class="info-item-1">I donâ€™t really review themes here, but sometimes you come across a really breautiful theme. I normally use the arc theme for my Linux Mint installation. Today I found out that Google is making its Chromebook to run native linux applications and some of the application will have the material theme. Chrome OS native app with material design   Looks pretty nice isnâ€™t it? To install just follow the instruction on the github repository Github For Arch users you can install it from the awesome AUR ...</div></div></div></a><a class="pagination-related" href="/2021/03/03/using-bitwarden/" title="Using Bitwarden as password manager"><img class="cover" src="/covers/bitwarden.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-03</div><div class="info-item-2">Using Bitwarden as password manager</div></div><div class="info-2"><div class="info-item-1">When I was in high school and starting to know about the danger of password being stolen, I started to change my password every 6 month. It got really crazy as I started to get more and more online accounts. During that time I have no list of all the online accounts and I often forget one of the account and I ended up forgot which pass password that account is using. The I realized using the same password for everything is not a good idea, also there are asshole websites that only allow you t...</div></div></div></a><a class="pagination-related" href="/2020/12/04/nu-keychip-1/" title="Sega Nu keychip (part 1)"><img class="cover" src="/covers/nukeychip.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-03</div><div class="info-item-2">Sega Nu keychip (part 1)</div></div><div class="info-2"><div class="info-item-1">IntroductionIn the Sega Nu systems, system boot and application start is gated by the mysterious â€œkeychipâ€. A lot of systems sold online do not include the keychip since they are property of Sega and needed to be returned once the operator terminate contract with Sega. I was lucky enough to find two keychip being auctioned and I want to document my reverse engineering efforts. Hopefull later people are able to use this information to reconstruct keychip for the game they want to launch and ke...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/261671" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">r1cebank</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">33</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">19</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/r1cebank"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/r1cebank" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:me@r1ce.net" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Welcome to my blog, this is where I record learnings and write about random stuff. Enjoy â¤ï¸<br> æ—§åšå®¢å†…å®¹å¯¼å…¥å®Œæˆï¼Œä¼šæ—¶ä¸æ—¶çš„æ›´æ–°æ–°å†…å®¹</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-1-Initramfs"><span class="toc-number">1.</span> <span class="toc-text">Step 1. Initramfs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-2-Init-script"><span class="toc-number">2.</span> <span class="toc-text">Step 2. Init script</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-3-Cryptsetup"><span class="toc-number">3.</span> <span class="toc-text">Step 3. Cryptsetup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-4-DCP"><span class="toc-number">4.</span> <span class="toc-text">Step 4. DCP</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/08/year-review-2025/" title="2025 Review"><img src="/covers/review-5.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2025 Review"/></a><div class="content"><a class="title" href="/2026/01/08/year-review-2025/" title="2025 Review">2025 Review</a><time datetime="2026-01-08T08:31:11.000Z" title="Created 2026-01-08 00:31:11">2026-01-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/03/building-bokaka-1/" title="Building Bokaka"><img src="/covers/building-bokaka-1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Building Bokaka"/></a><div class="content"><a class="title" href="/2026/01/03/building-bokaka-1/" title="Building Bokaka">Building Bokaka</a><time datetime="2026-01-03T19:43:18.000Z" title="Created 2026-01-03 11:43:18">2026-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/05/23/amptalk-interview/" title="My Interview Journey with Amptalk"><img src="/covers/amptalk-interview.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="My Interview Journey with Amptalk"/></a><div class="content"><a class="title" href="/2025/05/23/amptalk-interview/" title="My Interview Journey with Amptalk">My Interview Journey with Amptalk</a><time datetime="2025-05-23T07:00:00.000Z" title="Created 2025-05-23 00:00:00">2025-05-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/05/21/caddi-interview/" title="Why I Decided Not to Join CADDi"><img src="/covers/caddi-interview.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Why I Decided Not to Join CADDi"/></a><div class="content"><a class="title" href="/2025/05/21/caddi-interview/" title="Why I Decided Not to Join CADDi">Why I Decided Not to Join CADDi</a><time datetime="2025-05-21T06:31:54.000Z" title="Created 2025-05-20 23:31:54">2025-05-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/07/year-review-2024/" title="2024 Review"><img src="/covers/review-4.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2024 Review"/></a><div class="content"><a class="title" href="/2025/01/07/year-review-2024/" title="2024 Review">2024 Review</a><time datetime="2025-01-07T02:03:38.000Z" title="Created 2025-01-06 18:03:38">2025-01-06</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2021 - 2026 By r1cebank</span></div><div class="footer_custom_text">Made with â¤ï¸ in Vancouver</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3"></script><script src="/js/main.js?v=5.5.3"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? '' : ''

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>